---
name: cd-pypi

on:
  workflow_call:
    inputs:
      extra_twine_args:
        description: extra arguments for 'twine upload'
        type: string
        required: false
        default: ""
    secrets:  
      pypi_token:
        description: alternative token for uploading to pypi
        required: false

jobs:
  deploy:
    if: ${{ github.ref_type == 'tag' || github.event_name == 'release' }}
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.x"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install setuptools wheel twine build

    - name: Check version
      run: |
        if [ -f "setup.py" ]; then
          release=${{ github.ref_name }}
          version=$(python setup.py --version)
          test "$release" == "$version"
        fi

    - name: Build and publish
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.pypi_token || secrets.PYPI_API_TOKEN }}
      run: |
        python -m build
        twine upload ${{ extra_twine_args }} dist/*
